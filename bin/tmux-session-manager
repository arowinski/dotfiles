#!/bin/bash

# Simple tmux session manager
set -e

get_current_session() {
    if [ -n "$TMUX" ]; then
        tmux display-message -p '#S'
    else
        echo ""
    fi
}

get_sessions() {
    if ! tmux list-sessions >/dev/null 2>&1; then
        return 1
    fi
    
    local current_session
    current_session=$(get_current_session)
    
    # Use process substitution to avoid subshell
    while read -r name; do
        if [ "$name" = "$current_session" ]; then
            echo "● $name"
        else
            echo "  $name"
        fi
    done < <(tmux list-sessions -F "#{session_name}")
}

create_session() {
    local default_name session_name current_session
    default_name=$(basename "$PWD")
    current_session=$(get_current_session)
    
    echo -n "Session name [$default_name]: "
    read -r session_name < /dev/tty || return 1  # Handle Ctrl-C
    
    # Use default if empty
    session_name=${session_name:-$default_name}
    
    # Check if session exists
    if tmux has-session -t "$session_name" 2>/dev/null; then
        echo "Session '$session_name' already exists!"
        read -p "Press Enter to continue..." < /dev/tty
        return 1
    fi
    
    # Create and switch
    if [ -n "$current_session" ]; then
        tmux new-session -d -s "$session_name" -c "$PWD"
        tmux switch-client -t "$session_name"
    else
        tmux new-session -s "$session_name" -c "$PWD"
    fi
}

delete_session() {
    local session_to_delete current_session
    session_to_delete=${1#"● "}  # Remove indicator prefix
    session_to_delete=${session_to_delete#"  "}  # Remove spacer prefix
    current_session=$(get_current_session)
    
    if [ "$session_to_delete" = "$current_session" ]; then
        return 1  # Don't delete current session
    fi
    
    tmux kill-session -t "$session_to_delete" 2>/dev/null
}

switch_session() {
    local session_name current_session
    session_name=${1#"● "}  # Remove indicator prefix  
    session_name=${session_name#"  "}  # Remove spacer prefix
    current_session=$(get_current_session)
    
    if [ "$session_name" = "$current_session" ]; then
        return 0  # Already on this session
    fi
    
    if [ -n "$current_session" ]; then
        tmux switch-client -t "$session_name"
    else
        tmux attach-session -t "$session_name"
    fi
}

# Main loop
while true; do
    if ! sessions=$(get_sessions); then
        echo "No tmux sessions available"
        exit 1
    fi
    
    result=$(echo "$sessions" | fzf \
        --height=100% \
        --reverse \
        --header="Ctrl-X: delete | Ctrl-N: new session" \
        --bind="ctrl-x:execute-silent(echo delete:{})+abort" \
        --bind="ctrl-n:execute-silent(echo new)+abort" \
        --expect="ctrl-x,ctrl-n" 2>/dev/null) || exit 0
    
    key=$(echo "$result" | head -1)
    selection=$(echo "$result" | tail -1)
    
    case "$key" in
        "ctrl-x")
            [ -n "$selection" ] && delete_session "$selection"
            ;;
        "ctrl-n")
            create_session && exit 0
            ;;
        "")
            [ -n "$selection" ] && switch_session "$selection" && exit 0
            ;;
    esac
done